---
- name: "Get restapi status"
  ansible.builtin.uri:
    url: "http://localhost:{{ spilo_docker_patroni_restapi_listen_port }}/"
    method: GET
    validate_certs: false
    follow_redirects: none
    status_code: [200, 503]
  register: spilo_docker_r_restapi_info
  tags:
    - spilo
    - extra_users


- name: "Validating cluster leader"
  ansible.builtin.assert:
    that: ansible_play_hosts | map('extract', hostvars, ['spilo_docker_r_restapi_info', 'status']) | select('equalto', 200) | list | length == 1
    fail_msg: "Expected status 200 for exactly one host"
    quiet: true
  run_once: true
  tags:
    - spilo
    - extra_users


- name: "Create users"
  community.postgresql.postgresql_user:
    state: present
    name: "{{ item.name }}"
    password: "{{ item.pass }}"
    role_attr_flags: "{{ item.attr | default('LOGIN') }}"
    encrypted: true
    login_host: "localhost"
    login_port: "{{ spilo_docker_postgresql_listen_port }}"
    login_user: "{{ spilo_docker_superuser_name }}"
    login_password: "{{ spilo_docker_superuser_pass }}"
    login_db: "postgres"
  when: spilo_docker_r_restapi_info.status == 200
  loop: "{{ spilo_docker_extra_users | selectattr('name', 'defined') if spilo_docker_r_restapi_info.status == 200 else [] }}"
  loop_control:
    label: "{{ item.name }}"
  tags:
    - spilo
    - extra_users


- name: "Create databases"
  community.postgresql.postgresql_db:
    state: present
    name: "{{ item.base }}"
    encoding: "UTF-8"
    owner: "{{ item.name }}"
    login_host: "localhost"
    login_port: "{{ spilo_docker_postgresql_listen_port }}"
    login_user: "{{ spilo_docker_superuser_name }}"
    login_password: "{{ spilo_docker_superuser_pass }}"
    maintenance_db: "postgres"
  when: spilo_docker_r_restapi_info.status == 200
  loop: "{{ spilo_docker_extra_users | selectattr('name', 'defined') | selectattr('base', 'defined') if spilo_docker_r_restapi_info.status == 200 else [] }}"
  loop_control:
    label: "{{ item.base }} user={{ item.name }}"
  tags:
    - spilo
    - extra_users
